# 使用 YOLOv8 手部姿态识别实现简化版 Cytus 流程简述

## 核心概念

用摄像头捕捉玩家手部动作，通过 YOLOv8n-pose 模型识别手部关键点位置，以此代替传统的鼠标或触摸点击。判定机制从扫描线改为每个音符 (Note) 自身携带一个从大到小收缩的“判定圈”，圈缩至最小（与 Note 等大）时即为判定时刻。

## 整体流程

1.  **初始化阶段:**
    * 启动 Pygame 环境。
    * 初始化摄像头，确保能稳定获取视频流。
    * 加载预训练的 YOLOv8n-pose 模型。
    * 定义游戏内的 Note 序列（包含每个 Note 的出现时间 `appear_time` 和屏幕位置 `(x, y)`）。
    * 设定 Note 的基础样式（例如，一个小圆圈）。
    * 设定“判定圈”的初始大小（`max_radius`，比 Note 大）、收缩持续时间 (`duration`)。
    * 设定“接住”判定的容差范围 (`acceptance_radius`)，即手部关键点需要离 Note 中心多近才算成功。
    * 选择一个或多个手部关键点（例如，手腕 `wrist` 或食指指尖 `index_finger_tip`）作为玩家的“判定器”位置。

2.  **游戏循环 (Game Loop) - 每一帧执行:**

    * **a. 视频帧捕获:** 从摄像头获取当前帧图像。

    * **b. 手部姿态识别:**
        * 将当前帧图像输入 YOLOv8n-pose 模型进行处理。
        * 获取模型输出结果，提取识别到的手部关键点坐标。
        * **处理坐标:**
            * 筛选出选定的“判定器”关键点。
            * 处理未检测到手或检测到多只手的情况（例如，默认失败，或选择置信度最高/离屏幕中心最近的手）。
            * 将关键点的坐标从图像坐标系转换到 Pygame 的屏幕坐标系，得到实时的手部判定点位置 `(hand_x, hand_y)`。

    * **c. Note 与判定圈状态更新:**
        * 根据当前游戏时间，检查是否有新的 Note 到达 `appear_time`。
        * 若有，则将该 Note 状态设为 `appearing`，并为其创建一个关联的“判定圈”，设置其初始半径为 `max_radius`，记录开始收缩的时间。
        * 遍历所有状态为 `appearing` 或 `active` 的 Note：
            * 根据经过的时间和设定的 `duration`，更新其关联判定圈的当前半径 `current_radius` (使其逐渐缩小)。
            * 检查判定圈是否在本帧**恰好**收缩完成（即 `current_radius` 达到或小于 Note 的半径 `min_radius`）。

    * **d. 判定执行:**
        * 筛选出所有在本帧**恰好**完成判定圈收缩的 Note。
        * 对于每一个这样的 Note：
            * 获取其实际位置 `(note_x, note_y)`。
            * 获取步骤 (b) 中得到的当前手部判定点位置 `(hand_x, hand_y)`。
            * 计算手部判定点与 Note 中心的距离 `distance`。
            * **判断:**
                * 如果 `distance <= acceptance_radius` 并且检测到了有效的手部位置：
                    * 判定为 **"Hit" (接住)**。
                    * 更新 Note 状态为 `hit`。
                    * 增加分数，播放成功音效/视觉特效。
                * 否则 (距离太远或未检测到手)：
                    * 判定为 **"Miss" (错过)**。
                    * 更新 Note 状态为 `missed`。
                    * 播放失败音效/视觉特效，或进行相应惩罚。
            * 标记该 Note 已被判定，防止重复判定。

    * **e. 渲染绘制:**
        * 绘制游戏背景。
        * 绘制所有处于可见状态（`appearing`, `active`, 或短暂显示 `hit`/`missed` 效果）的 Note (内圈)。
        * 绘制所有正在收缩的“判定圈”(外圈)。
        * (可选) 绘制识别到的手部关键点位置，给玩家视觉反馈。
        * 绘制得分、连击数等 UI 元素。

    * **f. 屏幕更新:** 将绘制好的画面显示到屏幕上 (`pygame.display.flip()`)。

    * **g. 帧率控制:** 控制游戏循环的速度。

3.  **结束阶段:**
    * 游戏结束（例如，歌曲完成、生命值耗尽）。
    * 显示最终得分或结果。
    * 释放摄像头和 Pygame 资源。

## 关键点

* 核心输入来自实时手部追踪，取代了点击/触摸。
* 判定时机由每个 Note 自身的判定圈收缩动画决定，而非全局扫描线。
* 判定条件是空间位置的接近度，即手部在判定圈缩小的瞬间是否足够靠近 Note。